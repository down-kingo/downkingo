name: Roadmap Sync

on:
  # Manual trigger
  workflow_dispatch:

  # Scheduled sync (every 30 minutes)
  schedule:
    - cron: "*/30 * * * *"

  # Trigger on issue/project changes
  issues:
    types: [opened, edited, closed, labeled, unlabeled]

  project:
    types: [closed, edited, reopened]

# Prevent concurrent syncs
concurrency:
  group: roadmap-sync
  cancel-in-progress: true

permissions:
  contents: write
  issues: read
  repository-projects: read

jobs:
  sync:
    name: Sync Roadmap to CDN
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: roadmap-data
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # ============================================================
      # Step 1: Execute Roadmap Generator (Node.js)
      # ============================================================
      - name: Generate Roadmap (AI-Powered)
        env:
          GITHUB_TOKEN: ${{ secrets.ROADMAP_PAT }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ORG_NAME: "down-kingo"
          PROJECT_NUMBER: 2
        run: |
          node .github/scripts/generate_roadmap.js

      # ============================================================
      # Step 2: Commit and Push
      # ============================================================
      - name: Commit Changes to Data Branch
        run: |
          # Move generated files to data branch folder
          # Move all roadmap.*.json (roadmap.json, roadmap.pt-BR.json, etc)
          mv roadmap*.json roadmap-data/

          cd roadmap-data

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if files changed
          if git diff --quiet . 2>/dev/null; then
            echo "No changes detected, skipping commit"
            exit 0
          fi

          # Add all JSON files
          git add roadmap*.json
          git commit -m "chore: sync roadmap $(date +%Y-%m-%d)"
          git push origin roadmap-data

      - name: Trigger Cloudflare Pages Deploy
        if: success()
        run: |
          echo "Cloudflare Pages will auto-deploy from the roadmap-data branch"
          echo "URL: https://downkingo-roadmap.pages.dev/"
